<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Obƒçianske zdru≈æenie Podbansk√©</title>
<style>
:root {
  --primary-brown: #3A2F2A;
  --accent-gold: #B8860B;
  --neutral-cream: #F8F6F0;
  --neutral-off-white: #FDFDFC;
  --text-primary: #1A1A1A;
  --text-secondary: #6B6B6B;
  --radius-lg: 0.5rem;
  --space-4: 1rem;
  --space-6: 1.5rem;
  --font-body: 'Inter', sans-serif;
  --font-display: 'Playfair Display', serif;
}
body {
  font-family: var(--font-body);
  background: var(--neutral-cream);
  margin: 0;
  padding: var(--space-6);
  color: var(--text-primary);
}

.admin-section-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-6);
  align-items: start;
}

.preview-panel {
  background: var(--neutral-off-white);
  padding: var(--space-4);
  border-radius: var(--radius-lg);
  border: 1px solid rgba(0,0,0,0.1);
}

.hero-preview {
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 2rem;
  border-radius: var(--radius-lg);
  min-height: 300px;
  position: relative;
}

.preview-content {
  max-width: 600px;
}

.preview-eyebrow {
  color: var(--accent-gold);
  font-weight: 600;
  margin-bottom: 0.5em;
}

.preview-headline {
  font-family: var(--font-display);
  font-size: 2rem;
  margin: 0.5em 0;
}

.preview-description {
  font-size: 1.1em;
  line-height: 1.5;
}

.about-preview {
  display: grid;
  gap: 2rem;
  margin-bottom: 2rem;
}

.preview-image img {
  width: 100%;
  max-height: 200px;
  object-fit: cover;
  border-radius: var(--radius-lg);
}

.preview-lead {
  font-size: 1.2em;
  color: var(--primary-brown);
  font-weight: 500;
  margin-bottom: 1em;
}

.preview-text {
  color: var(--text-secondary);
  line-height: 1.6;
}

.contact-preview {
  background: var(--neutral-off-white);
  padding: var(--space-4);
  border-radius: var(--radius-lg);
}

.contact-preview h4 {
  color: var(--primary-brown);
  margin-top: 0;
}

.contact-preview p {
  color: var(--text-secondary);
  margin: 0.5em 0;
}
.hidden { display: none !important; }
h1, h2, h3 {
  font-family: var(--font-display);
  color: var(--primary-brown);
}
h1 { font-size: 2rem; margin-bottom: var(--space-4); }
h2 { margin-top: 0; margin-bottom: var(--space-4); }
h3 { font-size: 1.2rem; margin: var(--space-4) 0; }
.admin-page {
  max-width: 1100px;
  margin: 0 auto;
}
.admin-section {
  background: var(--neutral-off-white);
  padding: var(--space-4);
  border-radius: var(--radius-lg);
  box-shadow: 0 2px 12px rgba(0,0,0,0.05);
  margin-bottom: var(--space-6);
}
form > * {
  display: block;
  margin-bottom: var(--space-4);
}
input[type=text], input[type=password], input[type=email], input[type=file], textarea, select {
  width: 100%;
  padding: 0.5em;
  border: 2px solid rgba(58,47,42,0.1);
  border-radius: var(--radius-lg);
  font-family: var(--font-body);
  font-size: 1em;
  box-sizing: border-box;
}
textarea {
  min-height: 120px;
  resize: vertical;
}
button {
  padding: 0.6em 1.2em;
  border: none;
  border-radius: var(--radius-lg);
  background-color: var(--accent-gold);
  color: #fff;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.3s;
}
button:hover {
  background-color: #9a7209;
}
button.btn-danger {
  background-color: #B33232;
}
button.btn-danger:hover {
  background-color: #8a2626;
}
.flex-row {
  display: flex;
  gap: 1rem;
  align-items: center;
}
.flex-row > * {
  margin: 0;
}
.status-message {
  position: fixed;
  top: 10px;
  right: 10px;
  background: var(--accent-gold);
  color: white;
  padding: 12px 18px;
  border-radius: var(--radius-lg);
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  z-index: 10001;
  opacity: 0;
  transition: opacity 0.4s ease;
  pointer-events: none;
  max-width: 400px;
  word-wrap: break-word;
}
.status-message.visible {
  opacity: 1;
  pointer-events: auto;
}
.status-message.success {
  background: #10b981;
}
.status-message.error {
  background: #ef4444;
}
.status-message.warning {
  background: #f59e0b;
}
.status-message.info {
  background: #3b82f6;
}
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}
.loading-spinner {
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.item-list {
  max-height: 250px;
  overflow-y: auto;
  margin-top: 1em;
  border: 1px solid #ccc;
  border-radius: var(--radius-lg);
  padding: 0.5em;
  background: #fafafa;
}
label {
  font-weight: 600;
  margin-bottom: 0.3em;
  display: block;
}
.form-section {
  margin-bottom: 1.5em;
  padding: 1em;
  background: #f8f9fa;
  border-radius: var(--radius-lg);
  border-left: 4px solid var(--accent-gold);
}
.form-section h3 {
  margin-top: 0;
}
.button-group {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 1rem;
}
.item-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75em;
  border-bottom: 1px solid #eee;
}
.item-row:last-child {
  border-bottom: none;
}
@media (max-width: 768px) {
  .admin-section-layout {
    grid-template-columns: 1fr;
  }
  body {
    padding: 1rem;
  }
}
</style>
</head>
<body>

<div class="admin-page">
  <!-- Status Notification -->
  <div id="statusMessage" class="status-message"></div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
  </div>

  <!-- LOGIN SCREEN -->
  <section id="adminLoginScreen">
    <h1>Prihl√°senie do administr√°cie</h1>
    <form id="adminLoginForm">
      <div class="form-group">
        <label for="adminUsername">Pou≈æ√≠vateƒæsk√© meno</label>
        <input type="text" id="adminUsername" required>
      </div>
      <div class="form-group">
        <label for="adminPassword">Heslo</label>
        <input type="password" id="adminPassword" required>
      </div>
      <button type="submit">Prihl√°si≈• sa</button>
    </form>
    <div id="adminLoginError" style="color:red; display:none; margin-top:1em;"></div>
  </section>

  <!-- DASHBOARD -->
  <section id="adminDashboard" class="hidden">
    <h1>Administr√°torsk√Ω panel</h1>
    

    
    <div style="display: flex; gap: 1rem; margin-bottom: 15px; flex-wrap: wrap;">
      <button id="logoutBtn">Odhl√°si≈• sa</button>
      <button id="setupGitHubBtn" style="background-color: #6b7280;">‚öôÔ∏è Nastavenie GitHub</button>
      <button id="forceRefreshBtn" style="background-color: #10b981;" title="Obnov√≠ str√°nku so zmenami z GitHub">üîÑ Naƒç√≠ta≈• zmeny</button>
    </div>
    <div style="background: #dbeafe; border: 2px solid #3b82f6; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <strong>‚ÑπÔ∏è Automatick√° synchroniz√°cia:</strong> V≈°etky zmeny sa automaticky ukladaj√∫ priamo na GitHub. Po ulo≈æen√≠ poƒçkajte 1-2 min√∫ty a kliknite "üîÑ Naƒç√≠ta≈• zmeny" pre zobrazenie aktualiz√°ci√≠.
    </div>

    <!-- GitHub Setup Modal (hidden by default) -->
    <div id="githubSetupModal" class="hidden" style="background: white; padding: 2rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 2px solid #2563eb;">
      <h3>Nastavenie GitHub Sync</h3>
      <p style="color: #666; margin-bottom: 1rem;">Pre automatick√© publikovanie zmien potrebujete GitHub Personal Access Token.</p>
      
      <label for="githubToken">GitHub Personal Access Token</label>
      <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" style="margin-bottom: 1rem;">
      <small style="display: block; color: #666; margin-bottom: 1rem;">
        Vytvorte token na: <a href="https://github.com/settings/tokens/new" target="_blank">GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)</a><br>
        Potrebn√© opr√°vnenia: <code>repo</code> (Full control of private repositories)
      </small>
      
      <label for="githubRepo">Repository (username/repo-name)</label>
      <input type="text" id="githubRepo" placeholder="napr: username/website-podbanske" style="margin-bottom: 1rem;">
      
      <div style="display: flex; gap: 1rem;">
        <button onclick="saveGitHubConfig()" style="background-color: #16a34a;">üíæ Ulo≈æi≈• nastavenie</button>
        <button onclick="document.getElementById('githubSetupModal').classList.add('hidden')" style="background-color: #6b7280;">Zru≈°i≈•</button>
      </div>
    </div>

    <!-- Hero Section Management -->
    <div class="admin-section">
      <h2>Spr√°va √∫vodnej sekcie</h2>
      <div class="admin-section-layout">
        <div class="edit-panel">
          <form id="heroEditForm">
            <label for="heroEyebrow">Nadpis nad hlavn√Ωm titulkom</label>
            <input type="text" id="heroEyebrow">
            
            <label for="heroMainHeadline">Hlavn√Ω titulok</label>
            <input type="text" id="heroMainHeadline">
            
            <label for="heroSubHeadline">Podtitulok</label>
            <input type="text" id="heroSubHeadline">
            
            <label for="heroDescription">Popis</label>
            <textarea id="heroDescription"></textarea>
            
            <label for="heroBackgroundImageFile">Pozadie (Vybra≈• obr√°zok)</label>
            <input type="file" id="heroBackgroundImageFile" accept="image/*">
            <input type="hidden" id="heroBackgroundImage">
            
            <button type="submit">Ulo≈æi≈• zmeny</button>
          </form>
        </div>
        <div class="preview-panel">
          <h3>N√°hƒæad sekcie</h3>
          <div class="hero-preview" id="heroPreview">
            <div class="preview-content">
              <p class="preview-eyebrow"></p>
              <h2 class="preview-headline"></h2>
              <p class="preview-description"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- O n√°s Management -->
    <div class="admin-section">
      <h2>Spr√°va sekcie O n√°s</h2>
      <div class="admin-section-layout">
        <div class="edit-panel">
          <form id="aboutEditForm">
            <label for="aboutEyebrow">Nadpis mal√Ωmi (napr. "O NA≈†OM ZDRU≈ΩEN√ç")</label>
            <input type="text" id="aboutEyebrow" placeholder="O NA≈†OM ZDRU≈ΩEN√ç">
            
            <label for="aboutTitle">Hlavn√Ω nadpis</label>
            <input type="text" id="aboutTitle" placeholder="Posv√§tenos≈• hor√°m a komunite">
            
            <label for="aboutDescription">Popis pod nadpisom</label>
            <textarea id="aboutDescription" placeholder="aa"></textarea>
            
            <label for="aboutLeadText">Hlavn√Ω text</label>
            <textarea id="aboutLeadText" required></textarea>
            
            <label for="aboutContent">Obsah</label>
            <textarea id="aboutContent" required></textarea>
            
            <label for="aboutImageFile">Obr√°zok</label>
            <input type="file" id="aboutImageFile" accept="image/*">
            <input type="hidden" id="aboutImage">

            <h3>Kontaktn√© √∫daje</h3>
            <label for="contactAddress">Adresa</label>
            <textarea id="contactAddress"></textarea>

            <label for="contactPhone">Telef√≥n</label>
            <input type="text" id="contactPhone">

            <label for="contactEmail">Email</label>
            <input type="email" id="contactEmail">
            
            <button type="submit">Ulo≈æi≈• zmeny</button>
          </form>
        </div>
        <div class="preview-panel">
          <h3>N√°hƒæad sekcie</h3>
          <div class="about-preview" id="aboutPreview">
            <div class="preview-header">
              <p class="preview-eyebrow" style="color: #B8860B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;"></p>
              <h2 class="preview-title" style="font-family: 'Playfair Display', serif; font-size: 1.5rem; color: #3A2F2A; margin-bottom: 0.5rem;"></h2>
              <p class="preview-description" style="color: #6B6B6B; font-size: 0.95rem; margin-bottom: 1rem;"></p>
            </div>
            <div class="preview-image">
              <img src="" alt="N√°hƒæad obr√°zku">
            </div>
            <div class="preview-content">
              <h4 style="margin: 1rem 0 0.5rem 0; color: #3A2F2A;">Hlavn√Ω text:</h4>
              <div class="preview-lead" style="color: #1A1A1A; font-weight: 500; margin-bottom: 1rem; padding: 0.5rem; background: #F8F6F0; border-radius: 4px;"></div>
              <h4 style="margin: 1rem 0 0.5rem 0; color: #3A2F2A;">Obsah:</h4>
              <div class="preview-text" style="color: #6B6B6B; padding: 0.5rem; background: #FDFDFC; border-radius: 4px;"></div>
            </div>
          </div>
          <div class="contact-preview" id="contactPreview">
            <h4>Kontaktn√© √∫daje</h4>
            <p class="preview-address"></p>
            <p class="preview-phone"></p>
            <p class="preview-email"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Activities Management -->
    <div class="admin-section">
      <h2>Spr√°va aktiv√≠t</h2>
      
      <h3 style="margin-bottom: 0.5em;">Nadpisy sekcie</h3>
      <div style="background: #f0f8ff; padding: 1em; border-radius: 8px; margin-bottom: 1.5em;">
        <label for="activitiesEyebrow">Mal√Ω nadpis (eyebrow)</label>
        <input type="text" id="activitiesEyebrow" placeholder="napr. NA≈†E AKTIVITY">
        
        <label for="activitiesTitle">Hlavn√Ω nadpis</label>
        <input type="text" id="activitiesTitle" placeholder="Rozsiahla ƒçinnos≈• pre ochranu a rozvoj">
        
        <label for="activitiesDescription">Popis pod nadpisom</label>
        <textarea id="activitiesDescription" rows="2" placeholder="Ka≈æd√Ω z na≈°ich projektov..."></textarea>
        
        <button type="button" id="saveActivitiesHeaderBtn" style="background: #28a745; margin-top: 0.5em;">üíæ Ulo≈æi≈• nadpisy sekcie</button>
      </div>
      
      <h3 style="margin-bottom: 0.5em;">Spr√°va jednotliv√Ωch aktiv√≠t</h3>
      <form id="addActivityForm">
        <label for="activityTitle">N√°zov aktivity</label>
        <input type="text" id="activityTitle" required>
        
        <label for="activityDescription">Popis</label>
        <textarea id="activityDescription" required></textarea>
        
        <label for="activityCategory">Kateg√≥ria</label>
        <input type="text" id="activityCategory">
        
        <label for="activityImageFile">Obr√°zok</label>
        <input type="file" id="activityImageFile" accept="image/*">
        <input type="hidden" id="activityImage">
        
        <button type="submit">Prida≈•/Upravi≈• aktivitu</button>
      </form>
      <div id="activityList" class="item-list"></div>
      <!-- Debug: show raw activities JSON for troubleshooting -->
      <pre id="activityDebug" style="display:none; background:#fff; padding:0.5em; margin-top:0.75rem; border-radius:6px; overflow:auto; max-height:160px; border:1px dashed #ddd;"></pre>
    </div>

    <!-- Hist√≥ria Management -->
    <div class="admin-section">
      <h2>Spr√°va hist√≥rie</h2>
      <form id="historyEditForm">
        <label for="historyEyebrow">Mal√Ω nadpis (eyebrow)</label>
        <input type="text" id="historyEyebrow" placeholder="napr. HIST√ìRIA">
        
        <label for="historyTitle">Hlavn√Ω nadpis</label>
        <input type="text" id="historyTitle" required>
        
        <label for="historyDescription">Popis pod nadpisom</label>
        <textarea id="historyDescription" rows="2" placeholder="Kr√°tky popisn√Ω text"></textarea>
        
        <label for="historyContent">√övodn√Ω text</label>
        <textarea id="historyContent" required></textarea>
        
        <h3 style="margin-top: 1.5em; margin-bottom: 0.5em;">Podsekcie</h3>
        <div id="historySubsectionsContainer">
          <!-- Subsections will be rendered here -->
        </div>
        <button type="button" id="addHistorySubsectionBtn" style="background: #17a2b8; margin-top: 0.5em;">‚ûï Prida≈• podsekciu</button>
        
        <label for="historyImageFile" style="margin-top: 1em;">Obr√°zok</label>
        <input type="file" id="historyImageFile" accept="image/*">
        <input type="hidden" id="historyImage">
        
        <button type="submit">Ulo≈æi≈• zmeny</button>
        <button type="button" id="deleteHistoryBtn" style="background: #dc3545; margin-top: 0.5em;">üóëÔ∏è Vymaza≈• cel√∫ sekciu Hist√≥ria</button>
      </form>
    </div>

    <!-- Pr√≠roda Management -->
    <div class="admin-section">
      <h2>Spr√°va sekcie Pr√≠roda</h2>
      <form id="natureEditForm">
        <label for="natureEyebrow">Mal√Ω nadpis (eyebrow)</label>
        <input type="text" id="natureEyebrow" placeholder="napr. PR√çRODA">
        
        <label for="natureTitle">Hlavn√Ω nadpis</label>
        <input type="text" id="natureTitle" required>
        
        <label for="natureDescription">Popis pod nadpisom</label>
        <textarea id="natureDescription" rows="2" placeholder="Kr√°tky popisn√Ω text"></textarea>
        
        <label for="natureContent">√övodn√Ω text</label>
        <textarea id="natureContent" required></textarea>
        
        <h3 style="margin-top: 1.5em; margin-bottom: 0.5em;">Podsekcie</h3>
        <div id="natureSubsectionsContainer">
          <!-- Subsections will be rendered here -->
        </div>
        <button type="button" id="addNatureSubsectionBtn" style="background: #17a2b8; margin-top: 0.5em;">‚ûï Prida≈• podsekciu</button>
        
        <label for="natureImageFile" style="margin-top: 1em;">Obr√°zok</label>
        <input type="file" id="natureImageFile" accept="image/*">
        <input type="hidden" id="natureImage">
        
        <button type="submit">Ulo≈æi≈• zmeny</button>
        <button type="button" id="deleteNatureBtn" style="background: #dc3545; margin-top: 0.5em;">üóëÔ∏è Vymaza≈• cel√∫ sekciu Pr√≠roda</button>
      </form>
    </div>

    <!-- Pravidl√° Management -->
    <div class="admin-section">
      <h2>Spr√°va pravidiel</h2>
      <form id="rulesEditForm">
        <label for="rulesEyebrow">Mal√Ω nadpis (eyebrow)</label>
        <input type="text" id="rulesEyebrow" placeholder="napr. PRAVIDL√Å">
        
        <label for="rulesTitle">Hlavn√Ω nadpis</label>
        <input type="text" id="rulesTitle" required>
        
        <label for="rulesDescription">Popis pod nadpisom</label>
        <textarea id="rulesDescription" rows="2" placeholder="Kr√°tky popisn√Ω text"></textarea>
        
        <label for="rulesContent">√övodn√Ω text</label>
        <textarea id="rulesContent" required></textarea>
        
        <h3 style="margin-top: 1.5em; margin-bottom: 0.5em;">Podsekcie</h3>
        <div id="rulesSubsectionsContainer">
          <!-- Subsections will be rendered here -->
        </div>
        <button type="button" id="addRulesSubsectionBtn" style="background: #17a2b8; margin-top: 0.5em;">‚ûï Prida≈• podsekciu</button>
        
        <button type="submit" style="margin-top: 1em;">Ulo≈æi≈• zmeny</button>
        <button type="button" id="deleteRulesBtn" style="background: #dc3545; margin-top: 0.5em;">üóëÔ∏è Vymaza≈• cel√∫ sekciu Pravidl√°</button>
      </form>
    </div>

    <!-- Magick√© Podbansk√© Management -->
    <div class="admin-section">
      <h2>Spr√°va sekcie Magick√© Podbansk√©</h2>
      <form id="magicEditForm">
        <label for="magicEyebrow">Mal√Ω nadpis (eyebrow)</label>
        <input type="text" id="magicEyebrow" placeholder="napr. MAGICK√â PODBANSK√â">
        
        <label for="magicTitle">Hlavn√Ω nadpis</label>
        <input type="text" id="magicTitle" required>
        
        <label for="magicDescription">Popis pod nadpisom</label>
        <textarea id="magicDescription" rows="2" placeholder="Kr√°tky popisn√Ω text"></textarea>
        
        <label for="magicContent">√övodn√Ω text</label>
        <textarea id="magicContent" required></textarea>
        
        <h3 style="margin-top: 1.5em; margin-bottom: 0.5em;">Podsekcie</h3>
        <div id="magicSubsectionsContainer">
          <!-- Subsections will be rendered here -->
        </div>
        <button type="button" id="addMagicSubsectionBtn" style="background: #17a2b8; margin-top: 0.5em;">‚ûï Prida≈• podsekciu</button>
        
        <h3 style="margin-top: 1.5em; margin-bottom: 0.5em;">Obr√°zky</h3>
        <div id="magicImagesContainer">
          <!-- Images will be rendered here -->
        </div>
        <button type="button" id="addMagicImageBtn" style="background: #28a745; margin-top: 0.5em;">‚ûï Prida≈• obr√°zok</button>
        
        <button type="submit" style="margin-top: 1em;">Ulo≈æi≈• zmeny</button>
        <button type="button" id="deleteMagicBtn" style="background: #dc3545; margin-top: 0.5em;">üóëÔ∏è Vymaza≈• cel√∫ sekciu Magick√© Podbansk√©</button>
      </form>
    </div>

    <!-- Footer Text Management -->
    <div class="admin-section">
      <h2>Spr√°va p√§tiƒçky</h2>
      <form id="footerEditForm">
        <label for="footerText">Text v p√§tiƒçke</label>
        <input type="text" id="footerText">
        <button type="submit">Ulo≈æi≈• text</button>
      </form>
    </div>
  </section>
</div>

<!-- GitHub Sync Module -->
<script src="github-sync.js"></script>

<!-- Firebase initialization & sync (Storage + Firestore) -->
<script type="module" src="firebase-init.js"></script>
<script>
(() => {
  const statusMessageEl = document.getElementById("statusMessage");

  function notify(msg, type = 'info') {
    statusMessageEl.textContent = msg;
    statusMessageEl.className = 'status-message visible ' + type;
    setTimeout(() => statusMessageEl.classList.remove("visible"), type === 'error' ? 5000 : 3000);
  }

  function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  // Login Logic
  const adminLoginScreen = document.getElementById("adminLoginScreen");
  const adminDashboard = document.getElementById("adminDashboard");
  const loginForm = document.getElementById("adminLoginForm");
  const loginError = document.getElementById("adminLoginError");
  const logoutBtn = document.getElementById("logoutBtn");

  function showDashboard() {
    adminLoginScreen.classList.add("hidden");
    adminDashboard.classList.remove("hidden");
  }
  function showLogin() {
    adminLoginScreen.classList.remove("hidden");
    adminDashboard.classList.add("hidden");
  }
  function checkLogin() {
    return sessionStorage.getItem("loggedIn") === "true";
  }

  loginForm.addEventListener("submit", async e => {
    e.preventDefault();
    const username = document.getElementById("adminUsername").value.trim();
    const password = document.getElementById("adminPassword").value.trim();
    
    if (username === "admin" && password === "podban2024") {
      showLoading();
      try {
        sessionStorage.setItem("loggedIn", "true");
        showDashboard();
        await loadAllDataToForms();
        loginError.style.display = "none";
      } catch (err) {
        console.error('Login initialization failed:', err);
        notify('Prihl√°senie √∫spe≈°n√©, ale naƒç√≠tanie d√°t zlyhalo', 'warning');
      } finally {
        hideLoading();
      }
    } else {
      loginError.textContent = "Nespr√°vne prihlasovacie √∫daje";
      loginError.style.display = "block";
    }
  });

  logoutBtn.addEventListener("click", () => {
    sessionStorage.removeItem("loggedIn");
    showLogin();
    clearForms();
  });

  if (checkLogin()) {
    showDashboard();
  }
  


  // Data Keys
  const KEYS = {
    NAV: "siteNavigation",
    HERO: "heroSection",
    ABOUT: "aboutSection",
    ACTIVITIES: "adminActivities",
    ACTIVITIES_HEADER: "activitiesHeader",
    HISTORY: "historySection",
    NATURE: "natureSection",
    RULES: "rulesSection",
    MAGIC: "magicSection",
    CONTACT: "contactInfo",
    FOOTER: "footerText",
  };

  // Load data or default
  function getData(key, defaultValue) {
    let d = localStorage.getItem(key);
    if (!d) return defaultValue;
    try {
      return JSON.parse(d);
    } catch {
      return defaultValue;
    }
  }
  
  // ================= GitHub-only persistence =================
  function keyMapToFileField(k) {
    switch (k) {
      case KEYS.HERO: return 'hero';
      case KEYS.ABOUT: return 'about';
      case KEYS.ACTIVITIES: return 'activities';
      case KEYS.ACTIVITIES_HEADER: return 'activitiesHeader';
      case KEYS.HISTORY: return 'history';
      case KEYS.NATURE: return 'nature';
      case KEYS.RULES: return 'rules';
      case KEYS.MAGIC: return 'magic';
      case KEYS.CONTACT: return 'contact';
      case KEYS.FOOTER: return 'footer';
      default: return k;
    }
  }

  async function fetchRemoteDataJson() {
    try {
      if (!window.githubSync) {
        throw new Error('GitHub sync modul nie je naƒç√≠tan√Ω');
      }
      
      const file = await window.githubSync.getFile('data.json');
      if (!file || !file.content) {
        console.warn('data.json not found or empty');
        notify('‚ö†Ô∏è data.json nen√°jden√Ω - najsk√¥r nastavte GitHub Sync', 'warning');
        throw new Error('data.json not found');
      }
      
      const decoded = decodeURIComponent(escape(atob(file.content)));
      const data = JSON.parse(decoded);
      
      // Validate data structure
      if (typeof data !== 'object') {
        throw new Error('Neplatn√Ω form√°t data.json');
      }
      
      return data;
    } catch (e) {
      console.error('Fetch remote data.json failed', e);
      if (e.message.includes('401')) {
        notify('‚ùå Neplatn√Ω GitHub token - skontrolujte nastavenie', 'error');
      } else if (e.message.includes('404')) {
        notify('‚ùå S√∫bor data.json neexistuje v repozit√°ri', 'error');
      } else {
        notify('‚ùå Chyba pri naƒç√≠tan√≠: ' + e.message, 'error');
      }
      throw e;
    }
  }

  async function saveData(key, value) {
    showLoading();
    notify('üîÑ Uklad√°m na GitHub‚Ä¶', 'info');
    
    try {
      const data = await fetchRemoteDataJson();
      data[keyMapToFileField(key)] = value;
      
      await window.githubSync.updateFile(
        'data.json', 
        JSON.stringify(data, null, 2), 
        `Update ${keyMapToFileField(key)} - ${new Date().toLocaleString('sk-SK')}`
      );
      
      notify('‚úÖ √öspe≈°ne ulo≈æen√© na GitHub', 'success');
    } catch (err) {
      console.error('GitHub update failed', err);
      notify('‚ùå Chyba pri ukladan√≠: ' + err.message, 'error');
      throw err;
    } finally {
      hideLoading();
    }
  }



  // Image Upload Helper
  async function handleImageUpload(file, section) {
    if (!file) return null;
    // Try to use firebaseStorage if available, otherwise fallback to data URL
    try {
      if (window.firebaseStorage && typeof window.firebaseStorage.uploadImage === 'function') {
        const path = `images/${section}/${Date.now()}_${file.name}`;
        // If Firebase is available, prefer uploading and returning a public URL
        return await window.firebaseStorage.uploadImage(file, path);
      }
    } catch (err) {
      console.warn('Firebase upload failed:', err);
      // If Firebase exists but failed, do not fallback to data URL (may exceed Firestore limits)
      notify('Nahr√°vanie obr√°zka do cloudu zlyhalo. Sk√∫ste nesk√¥r.');
      return null;
    }

    // Fallback mode (when Firebase not present): compress image -> data URL to reduce size
    try {
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(e);
        reader.readAsDataURL(file);
      });
      // Compress using canvas (max 1200px, quality 0.7)
      const compressed = await compressDataUrl(dataUrl, 1200, 0.7);
      return compressed;
    } catch (err) {
      console.error('Failed to read file as DataURL:', err);
      notify('Nahr√°vanie obr√°zka zlyhalo');
      return null;
    }
  }

  async function compressDataUrl(dataUrl, maxSize = 1200, quality = 0.7) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        let { width, height } = img;
        if (width > height && width > maxSize) {
          height = Math.round((height * maxSize) / width);
          width = maxSize;
        } else if (height > maxSize) {
          width = Math.round((width * maxSize) / height);
          height = maxSize;
        }
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        const out = canvas.toDataURL('image/jpeg', quality);
        resolve(out);
      };
      img.onerror = () => resolve(dataUrl);
      img.src = dataUrl;
    });
  }

    // Hero Section Management
  const heroForm = document.getElementById("heroEditForm");
  const heroImageFile = document.getElementById("heroBackgroundImageFile");
  const heroImageHidden = document.getElementById("heroBackgroundImage");

  // Hero preview update function
  async function updateHeroPreview() {
    const eyebrowText = document.getElementById("heroEyebrow").value;
    const headlineText = document.getElementById("heroMainHeadline").value;
    const descriptionText = document.getElementById("heroDescription").value;
    
    const previewPanel = document.querySelector(".hero-preview");
    previewPanel.querySelector(".preview-eyebrow").textContent = eyebrowText;
    previewPanel.querySelector(".preview-headline").textContent = headlineText;
    previewPanel.querySelector(".preview-description").textContent = descriptionText;
    
    // Handle file input preview
    const fileInput = document.getElementById("heroBackgroundImageFile");
    if (fileInput.files && fileInput.files[0]) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewPanel.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)), url('${e.target.result}')`;
        previewPanel.style.backgroundSize = "cover";
        previewPanel.style.backgroundPosition = "center";
      };
      reader.readAsDataURL(fileInput.files[0]);
    } else if (heroImageHidden.value) {
      previewPanel.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)), url('${heroImageHidden.value}')`;
      previewPanel.style.backgroundSize = "cover";
      previewPanel.style.backgroundPosition = "center";
    }
  }

  // Update preview on input changes
  ["heroEyebrow", "heroMainHeadline", "heroSubHeadline", "heroDescription"].forEach(id => {
    document.getElementById(id).addEventListener("input", updateHeroPreview);
  });

  heroImageFile.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (file) {
      notify("Nahr√°vam obr√°zok...");
      const url = await handleImageUpload(file, 'hero');
      if (url) {
        heroImageHidden.value = url;
        notify("Obr√°zok bol nahran√Ω");
        updateHeroPreview();
      }
    }
  });

  heroForm.addEventListener("submit", async e => {
    e.preventDefault();
    
    const mainHeadline = document.getElementById("heroMainHeadline").value.trim();
    if (!mainHeadline) {
      notify('‚ö†Ô∏è Hlavn√Ω titulok je povinn√Ω', 'warning');
      return;
    }
    
    const heroData = {
      eyebrow: document.getElementById("heroEyebrow").value.trim(),
      mainHeadline: mainHeadline,
      subHeadline: document.getElementById("heroSubHeadline").value.trim(),
      description: document.getElementById("heroDescription").value.trim(),
      backgroundImage: heroImageHidden.value
    };
    
    try {
      await saveData(KEYS.HERO, heroData);
    } catch (err) {
      console.error('Hero save failed:', err);
    }
  });

  // About Section Management
  const aboutForm = document.getElementById("aboutEditForm");
  const aboutImageFile = document.getElementById("aboutImageFile");
  const aboutImageHidden = document.getElementById("aboutImage");

  // About section preview update function
  function updateAboutPreview() {
    const eyebrowText = document.getElementById("aboutEyebrow").value;
    const titleText = document.getElementById("aboutTitle").value;
    const descriptionText = document.getElementById("aboutDescription").value;
    const leadText = document.getElementById("aboutLeadText").value;
    const contentText = document.getElementById("aboutContent").value;
    const address = document.getElementById("contactAddress").value;
    const phone = document.getElementById("contactPhone").value;
    const email = document.getElementById("contactEmail").value;
    
    // Update about preview
    const aboutPreview = document.getElementById("aboutPreview");
    aboutPreview.querySelector(".preview-eyebrow").textContent = eyebrowText;
    aboutPreview.querySelector(".preview-title").textContent = titleText;
    aboutPreview.querySelector(".preview-description").textContent = descriptionText;
    aboutPreview.querySelector(".preview-lead").textContent = leadText;
    aboutPreview.querySelector(".preview-text").textContent = contentText;
    
    // Handle file input preview
    const fileInput = document.getElementById("aboutImageFile");
    const previewImg = aboutPreview.querySelector(".preview-image img");
    
    if (fileInput.files && fileInput.files[0]) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewImg.style.display = "block";
      };
      reader.readAsDataURL(fileInput.files[0]);
    } else if (aboutImageHidden.value) {
      previewImg.src = aboutImageHidden.value;
      previewImg.style.display = "block";
    } else {
      previewImg.style.display = "none";
    }
    
    // Update contact preview
    const contactPreview = document.getElementById("contactPreview");
    contactPreview.querySelector(".preview-address").innerHTML = address.replace(/\n/g, "<br>");
    contactPreview.querySelector(".preview-phone").textContent = phone;
    contactPreview.querySelector(".preview-email").textContent = email;
  }

  // Update preview on input changes
  ["aboutEyebrow", "aboutTitle", "aboutDescription", "aboutLeadText", "aboutContent", "contactAddress", "contactPhone", "contactEmail"].forEach(id => {
    document.getElementById(id).addEventListener("input", updateAboutPreview);
  });

  aboutImageFile.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (file) {
      notify("Nahr√°vam obr√°zok...");
      const url = await handleImageUpload(file, 'about');
      if (url) {
        aboutImageHidden.value = url;
        notify("Obr√°zok bol nahran√Ω");
        updateAboutPreview();
      }
    }
  });

  aboutForm.addEventListener("submit", async e => {
    e.preventDefault();
    
    const title = document.getElementById("aboutTitle").value.trim();
    const lead = document.getElementById("aboutLeadText").value.trim();
    const content = document.getElementById("aboutContent").value.trim();
    
    if (!title || !lead || !content) {
      notify('‚ö†Ô∏è V≈°etky povinn√© polia musia by≈• vyplnen√©', 'warning');
      return;
    }
    
    const aboutData = {
      eyebrow: document.getElementById("aboutEyebrow").value.trim(),
      title: title,
      description: document.getElementById("aboutDescription").value.trim(),
      lead: lead,
      content: content,
      image: document.getElementById("aboutImage").value
    };
    const contactData = {
      address: document.getElementById("contactAddress").value.trim(),
      phone: document.getElementById("contactPhone").value.trim(),
      email: document.getElementById("contactEmail").value.trim()
    };
    
    showLoading();
    notify('üîÑ Uklad√°m O n√°s + kontakt na GitHub‚Ä¶', 'info');
    
    try {
      const data = await fetchRemoteDataJson();
      data.about = aboutData;
      data.contact = contactData;
      
      await window.githubSync.updateFile(
        'data.json', 
        JSON.stringify(data, null, 2), 
        `Update about+contact - ${new Date().toLocaleString('sk-SK')}`
      );
      
      notify('‚úÖ O n√°s + kontakt ulo≈æen√© na GitHub', 'success');
    } catch (err) {
      console.error('Save about/contact failed', err);
      notify('‚ùå Chyba pri ukladan√≠: ' + err.message, 'error');
    } finally {
      hideLoading();
    }
  });

  // Activities Management
  const addActivityForm = document.getElementById("addActivityForm");
  const activityList = document.getElementById("activityList");
  const activityImageFile = document.getElementById("activityImageFile");
  const activityImageHidden = document.getElementById("activityImage");
  let activities = [];

  activityImageFile.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (file) {
      notify("Nahr√°vam obr√°zok...");
      const url = await handleImageUpload(file, 'activities');
      if (url) {
        activityImageHidden.value = url;
        notify("Obr√°zok bol nahran√Ω");
      }
    }
  });
  let editActivityIndex = -1;

  function renderActivities() {
    if (!activities.length) {
      activityList.innerHTML = '<p style="text-align:center;color:#666;">Zatiaƒæ neboli pridan√© ≈æiadne aktivity</p>';
      return;
    }
    activityList.innerHTML = activities.map((a,i) => `
      <div class="item-row">
        <span>${a.title}</span>
        <div>
          <button type="button" class="edit-activity" data-idx="${i}">Upravi≈•</button>
          <button type="button" class="delete-activity btn-danger" data-idx="${i}">Zmaza≈•</button>
        </div>
      </div>
    `).join("");
    attachActivityButtons();
  }

  function attachActivityButtons() {
    activityList.querySelectorAll(".edit-activity").forEach(btn => {
      btn.onclick = (e) => {
        const idx = e.target.dataset.idx;
        const activity = activities[idx];
        document.getElementById("activityTitle").value = activity.title || "";
        document.getElementById("activityDescription").value = activity.description || "";
        document.getElementById("activityCategory").value = activity.category || "";
        document.getElementById("activityImage").value = activity.image || "";
        document.getElementById("activityImageFile").value = "";
        editActivityIndex = parseInt(idx);
      };
    });
    activityList.querySelectorAll(".delete-activity").forEach(btn => {
      btn.onclick = (e) => {
        const idx = e.target.dataset.idx;
        activities.splice(idx, 1);
        saveData(KEYS.ACTIVITIES, activities);
        renderActivities();
        notify("Aktivita bola zmazan√°");
      };
    });
  }

  // Activities header management
  document.getElementById("saveActivitiesHeaderBtn").addEventListener("click", async () => {
    const headerData = {
      eyebrow: document.getElementById("activitiesEyebrow").value.trim(),
      title: document.getElementById("activitiesTitle").value.trim(),
      description: document.getElementById("activitiesDescription").value.trim()
    };
    await saveData(KEYS.ACTIVITIES_HEADER, headerData);
  });

  addActivityForm.addEventListener("submit", async e => {
    e.preventDefault();
    const activity = {
      title: document.getElementById("activityTitle").value.trim(),
      description: document.getElementById("activityDescription").value.trim(),
      category: document.getElementById("activityCategory").value.trim(),
      image: document.getElementById("activityImage").value
    };
    
    if (editActivityIndex >= 0) {
      activities[editActivityIndex] = activity;
      editActivityIndex = -1;
    } else {
      activities.push(activity);
    }
    
    await saveData(KEYS.ACTIVITIES, activities);
    addActivityForm.reset();
    renderActivities();
  });

  // Hist√≥ria Management
  const historyForm = document.getElementById("historyEditForm");
  const historyImageFile = document.getElementById("historyImageFile");
  const historyImageHidden = document.getElementById("historyImage");
  let historySubsections = [];

  function renderHistorySubsections() {
    const container = document.getElementById("historySubsectionsContainer");
    if (!container) return;
    
    container.innerHTML = historySubsections.map((subsec, index) => `
      <div style="border: 1px solid #ddd; padding: 1em; margin-bottom: 0.5em; border-radius: 8px; background: #f0f8ff;">
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1em;">
          <div style="flex: 1;">
            <label>Nadpis podsekcie</label>
            <input type="text" value="${subsec.title || ''}" onchange="updateHistorySubsectionTitle(${index}, this.value)" placeholder="N√°zov podsekcie" style="width: 100%; margin-bottom: 0.5em;">
            
            <label>Obsah podsekcie</label>
            <textarea onchange="updateHistorySubsectionContent(${index}, this.value)" placeholder="Text podsekcie" rows="4" style="width: 100%;">${subsec.content || ''}</textarea>
          </div>
          <button type="button" onclick="removeHistorySubsection(${index})" style="background: #dc3545; padding: 0.5em 1em;">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  window.updateHistorySubsectionTitle = (index, title) => {
    historySubsections[index].title = title;
  };

  window.updateHistorySubsectionContent = (index, content) => {
    historySubsections[index].content = content;
  };

  window.removeHistorySubsection = (index) => {
    historySubsections.splice(index, 1);
    renderHistorySubsections();
  };

  document.getElementById("addHistorySubsectionBtn").addEventListener("click", () => {
    historySubsections.push({ title: '', content: '' });
    renderHistorySubsections();
  });

  historyImageFile.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (file) {
      notify("Nahr√°vam obr√°zok...");
      const url = await handleImageUpload(file, 'history');
      if (url) {
        historyImageHidden.value = url;
        notify("Obr√°zok bol nahran√Ω");
      }
    }
  });

  historyForm.addEventListener("submit", async e => {
    e.preventDefault();
    const historyData = {
      eyebrow: document.getElementById("historyEyebrow").value.trim(),
      title: document.getElementById("historyTitle").value.trim(),
      description: document.getElementById("historyDescription").value.trim(),
      content: document.getElementById("historyContent").value.trim(),
      subsections: historySubsections.filter(sub => sub.title || sub.content),
      image: document.getElementById("historyImage").value
    };
    await saveData(KEYS.HISTORY, historyData);
  });

  // Delete History button
  document.getElementById("deleteHistoryBtn").addEventListener("click", async () => {
    const confirmText = "Naozaj chcete vymaza≈• cel√∫ sekciu Hist√≥ria?\n\nT√°to akcia je nevratn√°!";
    if (!confirm(confirmText)) return;
    
    showLoading();
    try {
      const data = await fetchRemoteDataJson();
      delete data.history;
      await window.githubSync.updateFile(
        'data.json', 
        JSON.stringify(data, null, 2), 
        'Delete history section'
      );
      
      document.getElementById("historyEyebrow").value = "";
      document.getElementById("historyTitle").value = "";
      document.getElementById("historyDescription").value = "";
      document.getElementById("historyContent").value = "";
      document.getElementById("historyImage").value = "";
      historySubsections = [];
      renderHistorySubsections();
      
      notify("‚úÖ Sekcia Hist√≥ria bola vymazan√°", 'success');
    } catch (err) {
      console.error('Delete history failed:', err);
      notify('‚ùå Chyba pri mazan√≠: ' + err.message, 'error');
    } finally {
      hideLoading();
    }
  });

  // Pr√≠roda Management
  const natureForm = document.getElementById("natureEditForm");
  const natureImageFile = document.getElementById("natureImageFile");
  const natureImageHidden = document.getElementById("natureImage");
  let natureSubsections = [];

  function renderNatureSubsections() {
    const container = document.getElementById("natureSubsectionsContainer");
    if (!container) return;
    
    container.innerHTML = natureSubsections.map((subsec, index) => `
      <div style="border: 1px solid #ddd; padding: 1em; margin-bottom: 0.5em; border-radius: 8px; background: #f0f8ff;">
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1em;">
          <div style="flex: 1;">
            <label>Nadpis podsekcie</label>
            <input type="text" value="${subsec.title || ''}" onchange="updateNatureSubsectionTitle(${index}, this.value)" placeholder="N√°zov podsekcie" style="width: 100%; margin-bottom: 0.5em;">
            
            <label>Obsah podsekcie</label>
            <textarea onchange="updateNatureSubsectionContent(${index}, this.value)" placeholder="Text podsekcie" rows="4" style="width: 100%;">${subsec.content || ''}</textarea>
          </div>
          <button type="button" onclick="removeNatureSubsection(${index})" style="background: #dc3545; padding: 0.5em 1em;">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  window.updateNatureSubsectionTitle = (index, title) => {
    natureSubsections[index].title = title;
  };

  window.updateNatureSubsectionContent = (index, content) => {
    natureSubsections[index].content = content;
  };

  window.removeNatureSubsection = (index) => {
    natureSubsections.splice(index, 1);
    renderNatureSubsections();
  };

  document.getElementById("addNatureSubsectionBtn").addEventListener("click", () => {
    natureSubsections.push({ title: '', content: '' });
    renderNatureSubsections();
  });

  natureImageFile.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (file) {
      notify("Nahr√°vam obr√°zok...");
      const url = await handleImageUpload(file, 'nature');
      if (url) {
        natureImageHidden.value = url;
        notify("Obr√°zok bol nahran√Ω");
      }
    }
  });

  natureForm.addEventListener("submit", async e => {
    e.preventDefault();
    const natureData = {
      eyebrow: document.getElementById("natureEyebrow").value.trim(),
      title: document.getElementById("natureTitle").value.trim(),
      description: document.getElementById("natureDescription").value.trim(),
      content: document.getElementById("natureContent").value.trim(),
      subsections: natureSubsections.filter(sub => sub.title || sub.content),
      image: document.getElementById("natureImage").value
    };
    await saveData(KEYS.NATURE, natureData);
  });

  // Delete Nature button
  document.getElementById("deleteNatureBtn").addEventListener("click", async () => {
    const confirmText = "Naozaj chcete vymaza≈• cel√∫ sekciu Pr√≠roda?\n\nT√°to akcia je nevratn√°!";
    if (!confirm(confirmText)) return;
    
    showLoading();
    try {
      const data = await fetchRemoteDataJson();
      delete data.nature;
      await window.githubSync.updateFile(
        'data.json', 
        JSON.stringify(data, null, 2), 
        'Delete nature section'
      );
      
      document.getElementById("natureEyebrow").value = "";
      document.getElementById("natureTitle").value = "";
      document.getElementById("natureDescription").value = "";
      document.getElementById("natureContent").value = "";
      document.getElementById("natureImage").value = "";
      natureSubsections = [];
      renderNatureSubsections();
      
      notify("‚úÖ Sekcia Pr√≠roda bola vymazan√°", 'success');
    } catch (err) {
      console.error('Delete nature failed:', err);
      notify('‚ùå Chyba pri mazan√≠: ' + err.message, 'error');
    } finally {
      hideLoading();
    }
  });

  // Pravidl√° Management
  const rulesForm = document.getElementById("rulesEditForm");
  let rulesSubsections = [];

  function renderRulesSubsections() {
    const container = document.getElementById("rulesSubsectionsContainer");
    if (!container) return;
    
    container.innerHTML = rulesSubsections.map((subsec, index) => `
      <div style="border: 1px solid #ddd; padding: 1em; margin-bottom: 0.5em; border-radius: 8px; background: #f0f8ff;">
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1em;">
          <div style="flex: 1;">
            <label>Nadpis podsekcie</label>
            <input type="text" value="${subsec.title || ''}" onchange="updateRulesSubsectionTitle(${index}, this.value)" placeholder="N√°zov podsekcie" style="width: 100%; margin-bottom: 0.5em;">
            
            <label>Obsah podsekcie</label>
            <textarea onchange="updateRulesSubsectionContent(${index}, this.value)" placeholder="Text podsekcie" rows="4" style="width: 100%;">${subsec.content || ''}</textarea>
          </div>
          <button type="button" onclick="removeRulesSubsection(${index})" style="background: #dc3545; padding: 0.5em 1em;">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  window.updateRulesSubsectionTitle = (index, title) => {
    rulesSubsections[index].title = title;
  };

  window.updateRulesSubsectionContent = (index, content) => {
    rulesSubsections[index].content = content;
  };

  window.removeRulesSubsection = (index) => {
    rulesSubsections.splice(index, 1);
    renderRulesSubsections();
  };

  document.getElementById("addRulesSubsectionBtn").addEventListener("click", () => {
    rulesSubsections.push({ title: '', content: '' });
    renderRulesSubsections();
  });

  rulesForm.addEventListener("submit", async e => {
    e.preventDefault();
    const rulesData = {
      eyebrow: document.getElementById("rulesEyebrow").value.trim(),
      title: document.getElementById("rulesTitle").value.trim(),
      description: document.getElementById("rulesDescription").value.trim(),
      content: document.getElementById("rulesContent").value.trim(),
      subsections: rulesSubsections.filter(sub => sub.title || sub.content)
    };
    await saveData(KEYS.RULES, rulesData);
  });

  // Delete Rules button
  document.getElementById("deleteRulesBtn").addEventListener("click", async () => {
    const confirmText = "Naozaj chcete vymaza≈• cel√∫ sekciu Pravidl√°?\n\nT√°to akcia je nevratn√°!";
    if (!confirm(confirmText)) return;
    
    showLoading();
    try {
      const data = await fetchRemoteDataJson();
      delete data.rules;
      await window.githubSync.updateFile(
        'data.json', 
        JSON.stringify(data, null, 2), 
        'Delete rules section'
      );
      
      document.getElementById("rulesEyebrow").value = "";
      document.getElementById("rulesTitle").value = "";
      document.getElementById("rulesDescription").value = "";
      document.getElementById("rulesContent").value = "";
      rulesSubsections = [];
      renderRulesSubsections();
      
      notify("‚úÖ Sekcia Pravidl√° bola vymazan√°", 'success');
    } catch (err) {
      console.error('Delete rules failed:', err);
      notify('‚ùå Chyba pri mazan√≠: ' + err.message, 'error');
    } finally {
      hideLoading();
    }
  });

  // Magick√© Podbansk√© Management
  const magicForm = document.getElementById("magicEditForm");
  let magicImages = [];
  let magicSubsections = [];

  function renderMagicSubsections() {
    const container = document.getElementById("magicSubsectionsContainer");
    if (!container) return;
    
    container.innerHTML = magicSubsections.map((subsec, index) => `
      <div style="border: 1px solid #ddd; padding: 1em; margin-bottom: 0.5em; border-radius: 8px; background: #f0f8ff;">
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1em;">
          <div style="flex: 1;">
            <label>Nadpis podsekcie</label>
            <input type="text" value="${subsec.title || ''}" onchange="updateMagicSubsectionTitle(${index}, this.value)" placeholder="N√°zov podsekcie" style="width: 100%; margin-bottom: 0.5em;">
            
            <label>Obsah podsekcie</label>
            <textarea onchange="updateMagicSubsectionContent(${index}, this.value)" placeholder="Text podsekcie" rows="4" style="width: 100%;">${subsec.content || ''}</textarea>
          </div>
          <button type="button" onclick="removeMagicSubsection(${index})" style="background: #dc3545; padding: 0.5em 1em;">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  window.updateMagicSubsectionTitle = (index, title) => {
    magicSubsections[index].title = title;
  };

  window.updateMagicSubsectionContent = (index, content) => {
    magicSubsections[index].content = content;
  };

  window.removeMagicSubsection = (index) => {
    magicSubsections.splice(index, 1);
    renderMagicSubsections();
  };

  document.getElementById("addMagicSubsectionBtn").addEventListener("click", () => {
    magicSubsections.push({ title: '', content: '' });
    renderMagicSubsections();
  });

  function renderMagicImages() {
    const container = document.getElementById("magicImagesContainer");
    if (!container) return;
    
    container.innerHTML = magicImages.map((img, index) => `
      <div style="border: 1px solid #ddd; padding: 1em; margin-bottom: 0.5em; border-radius: 8px; background: #f9f9f9;">
        <div style="display: flex; gap: 1em; align-items: start;">
          <div style="flex: 1;">
            <label>URL obr√°zka</label>
            <input type="text" value="${img.url || ''}" onchange="updateMagicImageUrl(${index}, this.value)" style="width: 100%;">
            
            <label style="margin-top: 0.5em;">Popis (voliteƒæn√Ω)</label>
            <input type="text" value="${img.caption || ''}" onchange="updateMagicImageCaption(${index}, this.value)" placeholder="Popis obr√°zka" style="width: 100%;">
            
            <label style="margin-top: 0.5em;">Nahra≈• s√∫bor</label>
            <input type="file" accept="image/*" onchange="uploadMagicImage(${index}, this.files[0])" style="width: 100%;">
          </div>
          ${img.url ? `<img src="${img.url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px;">` : ''}
          <button type="button" onclick="removeMagicImage(${index})" style="background: #dc3545; padding: 0.5em 1em;">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  window.updateMagicImageUrl = (index, url) => {
    magicImages[index].url = url;
  };

  window.updateMagicImageCaption = (index, caption) => {
    magicImages[index].caption = caption;
  };

  window.removeMagicImage = (index) => {
    magicImages.splice(index, 1);
    renderMagicImages();
  };

  window.uploadMagicImage = async (index, file) => {
    if (!file) return;
    notify("Nahr√°vam obr√°zok...");
    const url = await handleImageUpload(file, 'magic');
    if (url) {
      magicImages[index].url = url;
      renderMagicImages();
      notify("Obr√°zok bol nahran√Ω");
    }
  };

  document.getElementById("addMagicImageBtn").addEventListener("click", () => {
    magicImages.push({ url: '', caption: '' });
    renderMagicImages();
  });

  magicForm.addEventListener("submit", async e => {
    e.preventDefault();
    const magicData = {
      eyebrow: document.getElementById("magicEyebrow").value.trim(),
      title: document.getElementById("magicTitle").value.trim(),
      description: document.getElementById("magicDescription").value.trim(),
      content: document.getElementById("magicContent").value.trim(),
      subsections: magicSubsections.filter(sub => sub.title || sub.content),
      images: magicImages.filter(img => img.url)
    };
    await saveData(KEYS.MAGIC, magicData);
  });

  // Delete Magic button
  document.getElementById("deleteMagicBtn").addEventListener("click", async () => {
    const confirmText = "Naozaj chcete vymaza≈• cel√∫ sekciu Magick√© Podbansk√©?\n\nT√°to akcia je nevratn√°!";
    if (!confirm(confirmText)) return;
    
    showLoading();
    try {
      const data = await fetchRemoteDataJson();
      delete data.magic;
      await window.githubSync.updateFile(
        'data.json', 
        JSON.stringify(data, null, 2), 
        'Delete magic section'
      );
      
      document.getElementById("magicEyebrow").value = "";
      document.getElementById("magicTitle").value = "";
      document.getElementById("magicDescription").value = "";
      document.getElementById("magicContent").value = "";
      magicImages = [];
      magicSubsections = [];
      renderMagicImages();
      renderMagicSubsections();
      
      notify("‚úÖ Sekcia Magick√© Podbansk√© bola vymazan√°", 'success');
    } catch (err) {
      console.error('Delete magic failed:', err);
      notify('‚ùå Chyba pri mazan√≠: ' + err.message, 'error');
    } finally {
      hideLoading();
    }
  });

  // Footer Management
  const footerForm = document.getElementById("footerEditForm");
  footerForm.addEventListener("submit", async e => {
    e.preventDefault();
    const text = document.getElementById("footerText").value.trim();
    await saveData(KEYS.FOOTER, text);
  });

  // Load all data to forms
  // Initialize preview panels
  function initializePreviews() {
    updateHeroPreview();
    updateAboutPreview();
  }

  async function loadAllDataToForms() {
    showLoading();
    try {
      const remote = await fetchRemoteDataJson();
      const heroData = remote.hero || {};
      const aboutData = remote.about || {};
      const contactData = remote.contact || {};
      const activitiesHeaderData = remote.activitiesHeader || {};
      const historyData = remote.history || {};
      const natureData = remote.nature || {};
      const rulesData = remote.rules || {};
      const magicData = remote.magic || {};
      const footerText = remote.footer || '';

      // Fill hero form
      document.getElementById("heroEyebrow").value = heroData.eyebrow || "";
      document.getElementById("heroMainHeadline").value = heroData.mainHeadline || "";
      document.getElementById("heroSubHeadline").value = heroData.subHeadline || "";
      document.getElementById("heroDescription").value = heroData.description || "";
      document.getElementById("heroBackgroundImage").value = heroData.backgroundImage || "";

      // Fill about form (with contact)
      document.getElementById("aboutEyebrow").value = aboutData.eyebrow || "";
      document.getElementById("aboutTitle").value = aboutData.title || "";
      document.getElementById("aboutDescription").value = aboutData.description || "";
      document.getElementById("aboutLeadText").value = aboutData.lead || "";
      document.getElementById("aboutContent").value = aboutData.content || "";
      document.getElementById("aboutImage").value = aboutData.image || "";
      document.getElementById("contactAddress").value = contactData.address || "";
      document.getElementById("contactPhone").value = contactData.phone || "";
      document.getElementById("contactEmail").value = contactData.email || "";
    
      // Fill activities header
      document.getElementById("activitiesEyebrow").value = activitiesHeaderData.eyebrow || "";
      document.getElementById("activitiesTitle").value = activitiesHeaderData.title || "";
      document.getElementById("activitiesDescription").value = activitiesHeaderData.description || "";

      // Fill history form
      document.getElementById("historyEyebrow").value = historyData.eyebrow || "";
      document.getElementById("historyTitle").value = historyData.title || "";
      document.getElementById("historyDescription").value = historyData.description || "";
      document.getElementById("historyContent").value = historyData.content || "";
      document.getElementById("historyImage").value = historyData.image || "";
      historySubsections = historyData.subsections || [];
      renderHistorySubsections();

      // Fill nature form
      document.getElementById("natureEyebrow").value = natureData.eyebrow || "";
      document.getElementById("natureTitle").value = natureData.title || "";
      document.getElementById("natureDescription").value = natureData.description || "";
      document.getElementById("natureContent").value = natureData.content || "";
      document.getElementById("natureImage").value = natureData.image || "";
      natureSubsections = natureData.subsections || [];
      renderNatureSubsections();

      // Fill rules form
      document.getElementById("rulesEyebrow").value = rulesData.eyebrow || "";
      document.getElementById("rulesTitle").value = rulesData.title || "";
      document.getElementById("rulesDescription").value = rulesData.description || "";
      document.getElementById("rulesContent").value = rulesData.content || "";
      rulesSubsections = rulesData.subsections || [];
      renderRulesSubsections();

      // Fill magic form
      document.getElementById("magicEyebrow").value = magicData.eyebrow || "";
      document.getElementById("magicTitle").value = magicData.title || "";
      document.getElementById("magicDescription").value = magicData.description || "";
      document.getElementById("magicContent").value = magicData.content || "";
      magicSubsections = magicData.subsections || [];
      magicImages = magicData.images || [];
      renderMagicSubsections();
      renderMagicImages();

      // Fill footer form
      document.getElementById("footerText").value = footerText || "";

      // Render lists
      activities = remote.activities || [];
      renderActivities();
      
      notify('‚úÖ D√°ta √∫spe≈°ne naƒç√≠tan√©', 'success');
    } catch (err) {
      console.error('Failed to load data from GitHub:', err);
      notify('‚ö†Ô∏è D√°ta sa nepodarilo naƒç√≠ta≈• - skontrolujte GitHub Sync nastavenie', 'warning');
    } finally {
      hideLoading();
    }
  }

  // Clear all forms
  function clearForms() {
    document.querySelectorAll("form").forEach(form => form.reset());
    document.querySelectorAll('input[type="hidden"]').forEach(input => input.value = "");
    activityList.innerHTML = "";
  }

  // Initial load if logged in
  if (checkLogin()) {
    loadAllDataToForms();
    initializePreviews();
  }

  // ========== GITHUB SYNC FUNCTIONALITY ==========
  
  // Reload data from GitHub button
  document.getElementById("forceRefreshBtn")?.addEventListener("click", async () => {
    if (confirm('Naƒç√≠ta≈• najnov≈°ie d√°ta z GitHub?\n\nNeulo≈æen√© zmeny bud√∫ straten√©!')) {
      notify("üîÑ Naƒç√≠tavam zmeny z GitHub...", 'info');
      try {
        await loadAllDataToForms();
        notify('‚úÖ D√°ta aktualizovan√©', 'success');
      } catch (err) {
        notify('‚ùå Nepodarilo sa naƒç√≠ta≈• zmeny', 'error');
      }
    }
  });
  
  // Setup GitHub button
  document.getElementById("setupGitHubBtn").addEventListener("click", () => {
    const modal = document.getElementById("githubSetupModal");
    modal.classList.toggle("hidden");
    
    // Load existing config
    const token = localStorage.getItem('github-token');
    const repo = localStorage.getItem('github-repo');
    if (token) document.getElementById("githubToken").value = token;
    if (repo) document.getElementById("githubRepo").value = repo;
  });

  // Save GitHub config
  window.saveGitHubConfig = async function() {
    const token = document.getElementById("githubToken").value.trim();
    const repo = document.getElementById("githubRepo").value.trim();
    
    if (!token || !repo) {
      notify("‚ö†Ô∏è Vypl≈àte v≈°etky polia!", 'warning');
      return;
    }
    
    if (!repo.includes('/')) {
      notify("‚ö†Ô∏è Repository mus√≠ by≈• vo form√°te: username/repo-name", 'warning');
      return;
    }
    
    showLoading();
    try {
      window.githubSync.setup(token, repo);
      
      // Test connection by fetching data.json
      await fetchRemoteDataJson();
      
      document.getElementById("githubSetupModal").classList.add("hidden");
      notify("‚úÖ GitHub nastavenie ulo≈æen√© a overen√©!", 'success');
      
      // Reload data with new credentials
      await loadAllDataToForms();
    } catch (err) {
      notify('‚ùå Neplatn√© GitHub nastavenie: ' + err.message, 'error');
    } finally {
      hideLoading();
    }
  };



})();
</script>

</body>
</html>
